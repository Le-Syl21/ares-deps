librashader_name='librashader'
librashader_version='0.9.1'
librashader_url='https://github.com/SnowflakePowered/librashader.git'

librashader_setup() {
  echo "[librashader] cloning"
  git clone --branch librashader-v${librashader_version} --depth 1 ${librashader_url}
  echo "[librashader] cloning -- success"
}

librashader_package_source() {
  echo "[librashader] packaging source"
  mkdir -p ../ares-deps-source/src/librashader
  cp -R librashader/. ../ares-deps-source/src/librashader
  echo "[librashader] packaging source -- success"
}

librashader_patch() {
  echo "[librashader] patching -- skipped"
}

librashader_build() {
  echo "[librashader] building"
  cd librashader
  export RUSTFLAGS='-Ctarget-feature=+crt-static'
  export CXXFLAGS='-MT'
  export CFLAGS='-MT'
  if [[ $envName = windows-arm64 ]]; then
    echo "Targeting aarch64..."
    cargo build --release -p librashader-capi --target aarch64-pc-windows-msvc --no-default-features --features=runtime-opengl,stable
  else
    cargo build --release -p librashader-capi --no-default-features --features=runtime-opengl,stable
  fi
  unset RUSTFLAGS CXXFLAGS CFLAGS
  cd ..
  echo "[librashader] building -- success"
}

librashader_install() {
  echo "[librashader] installing"
  mkdir -p ares-deps/include/librashader/
  mkdir -p ares-deps/lib/
  cp -R build_temp/librashader/include/. ares-deps/include/librashader/

  if [[ $envName = windows-arm64 ]]; then
    local targetDir="build_temp/librashader/target/aarch64-pc-windows-msvc/release"
  else
    local targetDir="build_temp/librashader/target/release"
  fi

  cp ${targetDir}/librashader_capi.dll ares-deps/lib/librashader.dll
  cp ${targetDir}/librashader_capi.dll.lib ares-deps/lib/librashader.lib
  cp ${targetDir}/librashader_capi.pdb ares-deps/lib/librashader.pdb

  echo "[librashader] installing -- success"
}
