librashader_name='librashader'
librashader_version='0.9.1'
librashader_url='https://github.com/SnowflakePowered/librashader.git'

librashader_setup() {
  echo "[librashader] cloning"
  git clone --branch librashader-v${librashader_version} --depth 1 ${librashader_url}
  export MACOSX_DEPLOYMENT_TARGET=10.15
  echo "[librashader] cloning -- success"
}

librashader_package_source() {
  echo "[librashader] packaging source"
  ditto librashader ../ares-deps-source/src/librashader
  echo "[librashader] packaging source -- success"
}

librashader_patch() {
  echo "[librashader] patching -- skipped"
}

librashader_build() {
  echo "[librashader] building"
  cd librashader
  cargo build --release -p librashader-capi --features=stable --target x86_64-apple-darwin
  cargo build --release -p librashader-capi --features=stable --target aarch64-apple-darwin
  lipo -create -output target/release/librashader.dylib \
    target/x86_64-apple-darwin/release/liblibrashader_capi.dylib \
    target/aarch64-apple-darwin/release/liblibrashader_capi.dylib
  cd ..
  echo "[librashader] building -- success"
}

librashader_install() {
  echo "[librashader] installing"
  ditto build_temp/librashader/include ares-deps/include/librashader/
  ditto build_temp/librashader/target/release/librashader.dylib ares-deps/lib/librashader.dylib
  fix_rpaths ares-deps/lib/librashader.dylib
  ditto build_temp/librashader/LICENSE.md ares-deps/licenses/librashader/LICENSE.md
  ditto build_temp/librashader/LICENSE-GPL.md ares-deps/licenses/librashader/LICENSE-GPL.md
  echo "[librashader] installing -- success"
}
